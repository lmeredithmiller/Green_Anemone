---
title: "Project Test"
author: "Joan Moreaux"
date: "07/11/2021"
output: html_document
---

```{r, warning=FALSE, message=FALSE}
library(performance)
library(DHARMa)
library(mgcv)
library(fitdistrplus)
library(goft)
library(gamlss)
library(FSA) 
library(fGarch)
library(LambertW)
library(ordinal)
library(tidyverse)
```

```{r}
health_data <- read.csv("Big_Data_Green.csv")
heat_data <- read.csv("Heat_Data.csv")
```

## Health Data
Includes feeding time, PAM measurements, base measurements, and symbiont density 

```{r}
health_data <- health_data %>% 
  mutate(Fv_Fm_1 = as.numeric(Fv_Fm_1), PAM_avg = ((Fv_Fm_1 + Fv_Fm_2 + Fv_Fm_3)/3)) %>% 
  mutate(Base_Diameter_mm = (Base_Width + Base_Length + Base_Diagonal)/3) %>%
  mutate(Green_Density = (Green_Cells/1)*(1/0.1)*(1/0.001)*(0.5/Weight_Tentacle_g)) %>% 
  mutate(Dino_Density = (Dino_Cells/1)*(1/0.1)*(1/0.001)*(0.5/Weight_Tentacle_g)) %>%
  mutate(Bucket = as.factor(Bucket), Treatment = as.factor(Treatment), Event = as.factor(Event), 
         Species_ID = as.factor(Species_ID), Field_Site = as.factor(Field_Site))
```

### PAM data
```{r}
shapiro.test(health_data$PAM_avg) # p-value < 0.05, distribution is not normal
bartlett.test(PAM_avg ~ Treatment, data = health_data) # p-value < 0.05, does not meet equal variance assumptions
```

Checking distribution:
If we get get a p-value < 0.5, then they are significantly different and we should not test
```{r}
exp_test(health_data$PAM_avg)        #p-value < 2.2e-16, cannot use
gamma_test(health_data$PAM_avg)      #p-value < 2.2e-16, cannot use
lnorm_test(health_data$PAM_avg)      #p-value < 2.2e-16, cannot use
normal_test(health_data$PAM_avg)     #p-value = 5.414e-08, cannot use
weibull_test(health_data$PAM_avg)    #p-value < 2.2e-16, cannot use
```

```{r}
#Look for coral resiliancy Fv/Fm

PAM_visual <- fitDist(PAM_avg, data = health_data, type = "realAll", try.gamlss = T)

# Family:  c("SHASH", "Sinh-Arcsinh"), Fitting method: "nlminb" with 12% error
# Call:  gamlssML(formula = y, family = DIST[i]) 
```

Visualizing fistDist:
```{r}
histDist(y, family = SHASH, density = FALSE, 
        nbins = 10, xlab = "x", ylab = "y", data = PAM_visual, 
        col.hist = "gray", border.hist = "blue", 
        fg.hist = rainbow(12)[9])
```

Modelling fitDist:
```{r}
SHASH_data <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Green_Density, Dino_Density, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Green, MI_Dino, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3)) %>% 
  drop_na(PAM_avg) %>% 
  drop_na(Event_True) %>% 
  drop_na(Time_Point) %>% 
  filter(Species_ID != "G32B" & Species_ID != "G33B")

SHASH_data$orderTreatment = ordered(SHASH_data$Treatment, levels = c("Control", "25C", "30C"))

SHASH_model <- gamlss(formula = PAM_avg ~ Time_Point*Treatment + random(Species_ID), family = SHASH(), data = SHASH_data, control = gamlss.control(n.cyc = 200))

summary(SHASH_model)
#                         Estimate Std. Error t value Pr(>|t|)    
#(Intercept)              0.467240   0.007285  64.136   <2e-16 ***
#Time_Point               0.002956   0.001270   2.328   0.0206 *  
#Treatment25C            -0.158368   0.009339 -16.958   <2e-16 ***
#Treatment30C            -0.017513   0.009355  -1.872   0.0623 .  
#Time_Point:Treatment25C -0.001190   0.001675  -0.711   0.4780    
#Time_Point:Treatment30C -0.002611   0.001736  -1.504   0.1337  

#Time point and 25C is signifigant, 30C is not
#plot avg fv/fm over all time points (this was signifigantly different over time)
```

**PAM Graph**
We see no significant differences between treatments at different times of the experiment. 
```{r}
PAM_data_plot <- health_data %>% 
  filter(Event_True == "Acclimation_End" | Event_True == "Heat_End" | Event_True == "Recovery_End")

ggplot(PAM_data_plot, aes(x = Treatment, y = PAM_avg)) +
  geom_boxplot() +
  facet_grid(. ~ Event_True) +
  theme_test()
```

```{r}
PAM_data_end <- health_data %>% 
  filter(Event_True == "Heat_End") %>% 
  drop_na(PAM_avg)
```

```{r}
ggplot(PAM_data_end, aes(x = Treatment, y = PAM_avg)) +
  geom_boxplot() +
  theme_test()
```

### Symbiont Data
```{r}
filtered_dates <- health_data %>%
  filter(Date == "11/5/2021" | Date == "11/9/2021" | Date == "11/13/2021")

shapiro.test(filtered_dates$Green_Density)      #p-value < 0.05, not normal distribution
bartlett.test(Green_Density ~ Treatment, filtered_dates)      #p-value < 0.05, does not meet assumption of equal variance

shapiro.test(filtered_dates$Dino_Density)      #p-value < 0.05, not normal distribution
bartlett.test(Dino_Density ~ Treatment, filtered_dates)      #p-value < 0.05, does not meet assumption of equal variance
```

```{r}
ggplot(filtered_dates, aes(x = Date, y = Green_Density)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

```{r}
ggplot(filtered_dates, aes(x = Date, y = Dino_Density)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

### Size Data
```{r}
shapiro.test(filtered_dates$Base_Diameter_mm) # p-value = 0.001, distribution is not normal
bartlett.test(Base_Diameter_mm ~ Treatment, data = filtered_dates) # p-value = 0.30, yay equal variance
```

**Size Graph**
```{r}
ggplot(filtered_dates, aes(x = Date, y = Base_Diameter_mm)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

### Feeding Data
```{r}
shapiro.test(filtered_dates$Feeding_Time_Min)      #p-value < 0.05, not normal distribution
bartlett.test(Feeding_Time_Min ~ Treatment, filtered_dates)      #p-value < 0.01, does not meet assumption of equal variance

ggplot(filtered_dates, aes(x = Date, y = Feeding_Time_Min)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

### Heat Data
Includes temperature during heatwave and behavioral responses (open vs closed)

```{r}
heat_data <- heat_data %>% 
  mutate(Bucket = as.factor(Bucket), Treatment = as.factor(Treatment), Field_Site = as.factor(Field_Site)) %>% 
  group_by(Date, Treatment, Time_Block) %>% 
  mutate(Temp_avg = mean(Bucket_Temp))
```

```{r}
ggplot(data = heat_data, aes(x = Time_Block, y = Temp_avg, color = Date)) +
  geom_point() +
  geom_line() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

```{r}
open_closed_data <- heat_data %>% 
  group_by(Day, Treatment, Time_Block) %>% 
  count(Open_Closed)

ggplot(data = open_closed_data, aes(x = Time_Block, y = n, fill = Open_Closed)) + 
  geom_bar(position="fill", stat="identity") +
  facet_grid(. ~ Treatment) +
  scale_fill_brewer(palette = "Reds")
  theme_classic()
```


