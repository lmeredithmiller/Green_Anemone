---
title: "Initial Data Analysis"
author: "Joan Moreaux and Meredith Miller"
date: "07/11/2021"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, tidy=TRUE, tidy.opts = list(width.cutoff = 80))
```

```{r, warning=FALSE, message=FALSE}
library(performance)
library(DHARMa)
library(mgcv)
library(fitdistrplus)
library(goft)
library(gamlss)
library(FSA) 
library(fGarch)
library(LambertW)
library(ordinal)
library(cowplot)
library(here)
library(plotrix)
library(patchwork)
library(tidyverse)
```

```{r, warning=FALSE, message=FALSE}
health_data <- read.csv("Big_Data_Green.csv")
heat_data <- read.csv("Heat_Data.csv")
```

## Health Data
Includes feeding time, PAM measurements, base measurements, and symbiont density 

```{r, warning=FALSE, message=FALSE}
health_data <- health_data %>% 
  mutate(Fv_Fm_1 = as.numeric(Fv_Fm_1), PAM_avg = ((Fv_Fm_1 + Fv_Fm_2 + Fv_Fm_3)/3)) %>% 
  mutate(Base_Diameter_mm = (Base_Width + Base_Length + Base_Diagonal)/3) %>%
  mutate(Weight_Tentacle_mg = Weight_Tentacle_g*1000) %>% 
  mutate(Green_Density = (Green_Cells/1)*(1/0.1)*(1/0.001)*(0.5/Weight_Tentacle_mg)) %>% 
  mutate(Dino_Density = (Dino_Cells/1)*(1/0.1)*(1/0.001)*(0.5/Weight_Tentacle_mg)) %>%
  mutate(MI_Green = (Div_Green/Green_Cells)*100, MI_Dino = (Div_Dino/Dino_Cells)*100) %>% #Bates et al. 2010
  mutate(Bucket = as.factor(Bucket), Treatment = as.factor(Treatment), Date = as.factor(Date), 
         Event = as.factor(Event), Species_ID = as.factor(Species_ID), Field_Site = as.factor(Field_Site), 
         Event_True = as.factor(Event_True)) %>% 
  filter(Species_ID != "G32B" & Species_ID != "G33B") %>% 
  mutate(Treatment = fct_relevel(Treatment, "Control", "25C", "30C"), 
         Event = fct_relevel("Acclimation", "Pre-heat", "Post-heat", "Recovery"))
cols_for_heat = c("25C" = "sienna2", "30C" = "brown3", "Control" = "azure4")
```

We are combing the data from nov 5 (pre heat) and nov 9 (post heat) to be able to calculate the delta/change between these two dates. 
```{r}
nov_05 <- health_data %>% 
  filter(Date == "11/5/2021")

nov_09 <- health_data %>% 
  filter(Date == "11/9/2021")

delta_data = nov_05 %>%
  left_join(nov_09, by = "Species_ID") %>%
  mutate(Delta_Green_Density = Green_Density.y - Green_Density.x,
         Delta_Dino_Density = Dino_Density.y - Dino_Density.x,
         Field_Site = Field_Site.x,
         Acclimation_Period = Acclimation_Period.x,
         Date = Date.x,
         Treatment = Treatment.x) %>% 
  drop_na(Delta_Dino_Density, Delta_Green_Density) %>%
  select(Species_ID, Date, Field_Site, Acclimation_Period, Treatment, Delta_Green_Density, Delta_Dino_Density)
```

### Symbiont Data
#### PAM Threshold
```{r, warning=FALSE, message=FALSE}
Green_Threshold <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Div_Dino, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Dino, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True, Dino_Density)) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Time_Point) %>% 
  filter(Green_Density != 0)

Dino_Threshold <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Div_Green, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Green, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True, Green_Density)) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(Time_Point) %>% 
  filter(Dino_Density != 0)
```
From the data above, we decide that the threshold for PAM will be 1000 cells per mg (symbiont density).

#### Density Data
The two datasets below are used in models for algae density and mitotic index of zoochlorellae and zooxanthellae. It filters out unwanted columns and drops NAs for Green_Density, Dino_Density, MI_Green and MI_Dino.

```{r, warning=FALSE, message=FALSE}
Green_Symbionts <- health_data %>% 
  select(-c(Event, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g,
            Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start,
            Feeding_Stop, Photo_ID, Removed, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True)) %>% 
  filter(Date == "11/5/2021" | Date == "11/9/2021" | Date == "11/13/2021") %>% 
  mutate(Date = fct_relevel(Date, "11/5/2021", "11/9/2021", "11/13/2021")) %>% 
  mutate(Green_Density_Log = log(Green_Density)) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(MI_Green) %>% 
  drop_na(MI_Dino) %>% 
  filter(Green_Density != 0) %>% 
  mutate(Acclimation_Period = as.factor(Acclimation_Period)) %>% 
  group_by(Treatment, Date) %>% 
  mutate(Mean_Green_Log = mean(Green_Density_Log), SE_Green_Log = std.error(Green_Density_Log)) 

Dino_Symbionts <- health_data %>% 
  select(-c(Event, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True)) %>% 
  filter(Date == "11/5/2021" | Date == "11/9/2021" | Date == "11/13/2021") %>% 
  mutate(Date = fct_relevel(Date, "11/5/2021", "11/9/2021", "11/13/2021")) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(MI_Green) %>% 
  drop_na(MI_Dino) %>% 
  filter(Dino_Density != 0) %>% 
  mutate(Acclimation_Period = as.factor(Acclimation_Period))
```

Checking Normality and Equal Variance of Symbiont Data:
```{r, warning=FALSE, message=FALSE}
#Green
shapiro.test(Green_Symbionts$Green_Density)      #p-value < 0.05, not normal distribution
bartlett.test(Green_Density ~ Treatment, Green_Symbionts)      #p-value < 0.05, does not meet assumption of equal variance

#Dino
shapiro.test(Dino_Symbionts$Dino_Density)      #p-value < 0.05, not normal distribution
bartlett.test(Dino_Density ~ Treatment, Dino_Symbionts)      #p-value > 0.05, meets assumption of equal variance
```

Checking Distributions of Symbiont Data:
We first test distributions learned in class to see if they fit those with the normal data. We repeat this for both Green and Dino density.

```{r, warning=FALSE, message=FALSE}
#Greens
exp_test(Green_Symbionts$Green_Density)         #p-value < 0.05
gamma_test(Green_Symbionts$Green_Density)       #p-value > 0.05, larger i can use, p = 0.123
lnorm_test(Green_Symbionts$Green_Density)       #p-value < 0.05
normal_test(Green_Symbionts$Green_Density)      #p-value < 0.05, not a normal distribution
weibull_test(Green_Symbionts$Green_Density)     #p-value > 0.05, larger i can use, p = 0.44

#Use Weibull since p value is larger than gamma
Green_Weibull <- histDist(Green_Symbionts$Green_Density, "WEI", density = F, main = "Weibull")

#Dinos
exp_test(Dino_Symbionts$Dino_Density)           #p-value > 0.05
gamma_test(Dino_Symbionts$Dino_Density)         #p-value > 0.05, larger i can use, p = 0.6709
lnorm_test(Dino_Symbionts$Dino_Density)         #p-value < 0.05
normal_test(Dino_Symbionts$Dino_Density)        #p-value < 0.05, not a normal distribution
weibull_test(Dino_Symbionts$Dino_Density)       #p-value > 0.05, larger i can use, p = 0.774

#Use Gamma since p value is larger than weibull
Dino_Gamma <- histDist(Dino_Symbionts$Dino_Density, "GA", density = F, main = "Gamma")
```

Running Models on Symbiont Data:
We chose to use our Weibull distribution for green density and Gamma distribution for dino density. Here we run our models.
```{r, warning=FALSE, message=FALSE}
#Green
Green_Symbionts$orderTreatment = ordered(Green_Symbionts$Treatment, levels = c("Control", "25C", "30C"))

Green_Weibull_model <- gamlss(formula = Green_Density ~ Date*Treatment + random(Species_ID) + random(Field_Site) + random(Acclimation_Period), family = WEI(), data = Green_Symbionts, control = gamlss.control(n.cyc = 10))
summary(Green_Weibull_model)

#Dino
Dino_Symbionts$orderTreatment = ordered(Dino_Symbionts$Treatment, levels = c("Control", "25C", "30C"))

Dino_Gamma_model <- gamlss(formula = Dino_Density ~ Date*Treatment + random(Species_ID) + random(Field_Site) + random(Acclimation_Period), family = GA(), data = Dino_Symbionts, control = gamlss.control(n.cyc = 3))
summary(Dino_Gamma_model)
```
The green density data was run with a weibull distribution. This model shows significance in 30C treatment.
Data from running with time points

Change in density calculations on Symbiont data
```{r}
Delta_Data_model <- delta_data %>% 
  mutate(Green_Density_Scaled = Delta_Green_Density + 0.01) %>% 
  mutate(Dino_Density_Scaled = Delta_Dino_Density + 0.01) %>% 
  mutate(Green_log = log(abs(Green_Density_Scaled))) %>% 
  mutate(Dino_log = log(abs(Dino_Density_Scaled))) 
```

 ST2      ST1      SST     EGB2      SN2      JSU     
144.9808 144.9809 144.9875 145.5837 146.8703 148.2934  

```{r}
#Green
DeltaGreen_fist <- fitDist(Green_log, data = Delta_Data_model, type = "realline", try.gamlss = T)
DeltaGreen_hist <- histDist(Delta_Data_model$Green_log, "JSU", density = F, main = "JSU")

# check distributions with similar AIC values
DeltaGreen_fist$fits

DeltaGreen_model <- gamlss(formula = Green_log ~ Treatment + random(Species_ID) + random(Field_Site), family = JSU(), method = CG(), data = Delta_Data_model, control = gamlss.control(n.cyc = 300))
summary(DeltaGreen_model)

#Dino
DeltaDino_fist <- fitDist(Dino_log, data = Delta_Data_model, type = "realline", try.gamlss = T)
DeltaGreen_hist <- histDist(Delta_Data_model$Dino_log, "PE2", density = F, main = "Power Exponential Type 2")

DeltaDino_model <- gamlss(formula = Dino_log ~ Treatment + random(Species_ID) + random(Field_Site), family = PE2(), method = mixed(50,100), data = Delta_Data_model, control = gamlss.control(n.cyc = 250))
summary(DeltaDino_model)
```

Plots for symbiont data:
```{r, warning=FALSE, message=FALSE, out.length="50%"}
green_plot <- ggplot(Green_Symbionts, aes(x = Date, y = log(Green_Density), fill = Treatment)) +
  geom_boxplot(alpha = 0.85) +
  xlab("Event") +
  ylab("Log-transformed ZC density (cells/mg)") +
  facet_grid(. ~ Treatment) +
  scale_color_manual(values = cols_for_heat) +
  scale_fill_manual(values = cols_for_heat) +
  theme_test()
green_plot <- green_plot + ylim(0,12) + scale_x_discrete(labels=c("11/5/2021" = "Pre-heat", "11/9/2021" = "Post-heat",
                              "11/13/2021" = "Recovery"))

dino_plot <- ggplot(Dino_Symbionts, aes(x = Date, y = log(Dino_Density), fill = Treatment)) +
  geom_boxplot(alpha = 0.85) +
  xlab("Event") +
  ylab("Log-transformed ZX density (cells/mg)") +
  facet_grid(. ~ Treatment) +
  scale_color_manual(values = cols_for_heat) +
  scale_fill_manual(values = cols_for_heat) +
  theme_test()
dino_plot <- dino_plot + ylim(0,12) + scale_x_discrete(labels=c("11/5/2021" = "Pre-heat", "11/9/2021" = "Post-heat",
                              "11/13/2021" = "Recovery"))

density_plot = (green_plot + dino_plot) + plot_layout(ncol=1)
density_plot <- density_plot + plot_annotation(tag_levels = 'A')
density_plot

ggsave(here("./images/density_plot.png"), density_plot, width = 10, height = 9)
```

NOT NEEDED BECAUSE NOT USING DELTA
I am doing a little Dan-hack on the data for the purpose of this graph. 

```{r}
delta_green_only <- delta_data %>% 
  mutate(Density = Delta_Green_Density) %>% 
  mutate(Colour = rep("Green")) %>% 
  select(-c(Delta_Dino_Density, Delta_Green_Density))
  
  
delta_dino_only <- delta_data %>% 
  mutate(Density = Delta_Dino_Density) %>% 
  mutate(Colour = rep("Dino")) %>% 
  select(-c(Delta_Green_Density, Delta_Dino_Density))

delta_for_plot <- rbind(delta_green_only, delta_dino_only)
```

```{r}
cols_for_symbiont = c("Dino" = "chocolate4", "Green" = "darkgreen")
delta_density_plot <- ggplot(delta_for_plot, aes(x = Treatment, y = Density, fill = Colour)) +
  geom_boxplot(alpha = 0.7) +
  scale_fill_manual(values = cols_for_symbiont) +
  theme_test()
delta_density_plot
```

```{r}
green_over_time <- ggplot(data = Green_Symbionts, aes(x=Date, y = Mean_Green_Log, colour = Treatment, group = Treatment)) +
  theme_classic() +
  geom_point(size=2.5) +
  geom_linerange(aes(ymin = Mean_Green_Log - SE_Green_Log, 
                     ymax = Mean_Green_Log + SE_Green_Log)) +
  geom_line() +
  labs(x="Date", 
       y = "Mean Green") +
  scale_fill_manual(values = cols_for_heat) +
  scale_colour_manual(values = cols_for_heat)
green_over_time
```

#### Mitotic Index Data
```{r}
MI_Data <- health_data %>% 
  select(-c(Event, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True)) %>% 
  filter(Date == "11/5/2021" | Date == "11/9/2021" | Date == "11/13/2021") %>% 
  mutate(Date = fct_relevel(Date, "11/5/2021", "11/9/2021", "11/13/2021")) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(MI_Green) %>% 
  drop_na(MI_Dino) %>% 
  mutate(Acclimation_Period = as.factor(Acclimation_Period)) %>% 
  mutate(MI_Dino_scaled = MI_Dino + 0.01) %>% 
  mutate(MI_Green_scaled = MI_Green + 0.01)
```

Transformation of MI Data:
```{r}
#Green
MIGreen_log <- MI_Data %>% mutate(MI_Data = log(abs(MI_Green + 0.01)))
shapiro.test(MIGreen_log$MI_Data)      #p-value < 0.05, not normal distribution

#Dino
MIDino_log <- MI_Data %>% mutate(MI_Data = log(abs(MI_Dino + 0.01)))
shapiro.test(MIDino_log$MI_Data)      #p-value < 0.05, not normal distribution
```

Checking Distributions on MI data:

MI GREEN AND MI DINO NOT FOUND *** trouble shoot 
```{r, warning=FALSE, message=FALSE}
#Greens
exp_test(MI_Data$MI_Green)         #p-value = NA
gamma_test(MI_Data$MI_Green)       #p-value = NA
lnorm_test(MI_Data$MI_Green)       #p-value = NA
normal_test(MI_Data$MI_Green)      #p-value < 0.05, not normal
weibull_test(MI_Data$MI_Green)     #p-value = NA

MIGreen_fit <- fitDist(MI_Green, data = MI_Data, type = "realline", try.gamlss = T)
#family JSUo 
MIGreen_hist <- histDist(MI_Data$MI_Green, "JSUo", density = F, main = "Johnson SU original")

dunnTest(MI_Green ~ Treatment, data = MI_Data)

#Dinos
exp_test(MI_Data$MI_Dino)           #p-value = NA
gamma_test(MI_Data$MI_Dino)         #p-value = NA
lnorm_test(MI_Data$MI_Dino)         #p-value = NA
normal_test(MI_Data$MI_Dino)        #p-value < 0.05, not normal
weibull_test(MI_Data$MI_Dino)       #p-value = NA

MIDino_fit <- fitDist(MI_Dino_scaled, data = MI_Data, type = "realAll", try.gamlss = T)
#family SHASHo
MIDino_hist <- histDist(Dino0$MI_Dino_scaled, "SHASHo", density = T, main = "SHASHo")

dunnTest(MI_Dino ~ Treatment, data = MI_Data)

```

```{r}
dunnTest(MI_Green ~ Treatment, data = MI_Data)
dunnTest(MI_Dino ~ Treatment, data = MI_Data)
```

Running Models on MI data:
```{r}
#Green
# MI_Data$orderTreatment = ordered(MI_Data$Treatment, levels = c("Control", "25C", "30C"))
# 
# Green_JSUo_model <- gamlss(formula = MI_Green_Scaled ~ Treatment + random(Species_ID) + random(Field_Site) + random(Acclimation_Period), family = JSUo(), data = MI_Data, control = gamlss.control(n.cyc = 250))
# # summary(Green_JSUo_model)
# 
# #Dino
# MI_Data$orderTreatment = ordered(MI_Data$Treatment, levels = c("Control", "25C", "30C"))
# 
# Dino_SHASHo_model <- gamlss(formula = MI_Dino_Scaled ~ Treatment + random(Species_ID) + random(Field_Site) + random(Acclimation_Period), family = SHASHo(), data = test, control = gamlss.control(n.cyc = 250))
# # summary(Dino_SHASHo_model)
```

```{r}
green_MI_plot <- ggplot(Green_Symbionts, aes(x = Date, y = MI_Green)) +
  geom_boxplot() +
  xlab("Event") +
  ylab("Mitotic index") +
  facet_grid(. ~ Treatment) +
  theme_test()
green_MI_plot + scale_x_discrete(labels=c("11/5/2021" = "Pre-heat", "11/9/2021" = "Post-heat",
                              "11/13/2021" = "Recovery"))
```

### PAM data
```{r}
PAM_individuals <- health_data %>% 
  filter(Green_Density > 1000 | Dino_Density > 1000) %>% 
  distinct(Species_ID)

PAM_data <- health_data %>% 
  select(-c(Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles,
            Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, 
            Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, Div_Green, Div_Dino, 
            MI_Green, MI_Dino, Acclimation_Period, Green_Density, Dino_Density)) %>%
  drop_na(Time_Point) %>%
  drop_na(PAM_avg) %>%
  group_by(Treatment, Date) %>% 
  mutate(Mean_PAM = mean(PAM_avg), SE_PAM = std.error(PAM_avg))

filtered_PAM_data = PAM_individuals %>%
  left_join(PAM_data) %>% 
  filter(Date == "11/6/2021" | Date == "11/9/2021" | Date == "11/13/2021") %>% 
  filter(Time_Point != 4) %>% 
  mutate(Date = fct_relevel(Date, "11/6/2021", "11/9/2021", "11/13/2021")) 
```

```{r}
anova_PAM <- aov(PAM_avg ~ Treatment, data = filtered_PAM_data)
summary(anova_PAM) # not significant
```

```{r}
kruskal.test(PAM_avg ~ Treatment, data = filtered_PAM_data)
dunnTest(PAM_avg ~ Treatment, data = filtered_PAM_data) 
```

```{r, warning=FALSE, message=FALSE}
shapiro.test(filtered_PAM_data$PAM_avg) # p-value < 0.05, distribution is not normal
bartlett.test(PAM_avg ~ Treatment, data = filtered_PAM_data) # p-value < 0.05, does not meet equal variance assumptions
```

Our data does not meet the assumption and therefore we will not be able to use tests such as ANOVA and linear models. 

Checking distribution on PAM data:
If we get get a p-value < 0.5, then they is a significant differnce between the data and the distribution, and therefore this model should not be used in our analyse.

```{r, warning=FALSE, message=FALSE}
exp_test(filtered_PAM_data$PAM_avg)        #p-value < 0.05, cannot use
gamma_test(filtered_PAM_data$PAM_avg)      #p-value < 0.05, cannot use
lnorm_test(filtered_PAM_data$PAM_avg)      #p-value < 0.05, cannot use
normal_test(filtered_PAM_data$PAM_avg)     #p-value < 0.05, not normal
weibull_test(filtered_PAM_data$PAM_avg)    #p-value < 0.05, cannot use
```

Since we cannot use any that we learned in class, we are using fitDist to check many distributions at once. fitDist showed that the SHASH distribution fits the best with our data, so we can use histDist to visualize it. 

**SHASH Distribution Graph for PAM Data**
```{r, warning=FALSE, message=FALSE}
#Look for anemone resiliancy Fv/Fm

PAM_visual <- fitDist(PAM_avg, data = filtered_PAM_data, type = "realAll", try.gamlss = T)
PAM_visual

#Visualizing fistDist

histDist(y, family = SHASH, density = FALSE, 
        nbins = 10, xlab = "x", ylab = "y", data = PAM_visual, 
        col.hist = "gray", border.hist = "blue", 
        fg.hist = rainbow(12)[9])
```

This data tells us to use the SHASH distribution for our PAM model. 

```{r, warning=FALSE, message=FALSE}
#Modelling fitDist
#PAM_model <- gamlss(formula = PAM_avg ~ Date*Treatment + random(Species_ID), family = SHASH(), data = filtered_PAM_data, control = gamlss.control(n.cyc = 250))
# 
# summary(PAM_model)
```

Findings:
* Time point and 25C is significant, 30C is not
* Plot avg fv/fm over all time points (this was significantly different over time)

###### LOG transformation of PAM
```{r}
# log_PAM <- filtered_PAM_data %>%
#   mutate(log_PAM = log(PAM_avg))
# 
# shapiro.test(log_PAM$PAM_avg) # p-value < 0.05, distribution is not normal
# bartlett.test(PAM_avg ~ Treatment, data = log_PAM) # p-value < 0.05, does not meet equal variance assumptions
# 
# exp_test(log_PAM$PAM_avg)        #p-value < 0.05, cannot use
# gamma_test(log_PAM$PAM_avg)      #p-value < 0.05, cannot use
# lnorm_test(log_PAM$PAM_avg)      #p-value < 0.05, cannot use
# normal_test(log_PAM$PAM_avg)     #p-value < 0.05, cannot use
# weibull_test(log_PAM$PAM_avg)    #p-value < 0.05, cannot use
# 
# #Look for anemone resiliancy Fv/Fm
# 
# PAM_log_visual <- fitDist(PAM_avg, data = log_PAM, type = "realAll", try.gamlss = T)
# PAM_log_visual #gives SHASH
# 
# #Visualizing fistDist
# 
# histDist(y, family = SHASH, density = FALSE,
#         nbins = 10, xlab = "x", ylab = "y", data = PAM_log_visual,
#         col.hist = "gray", border.hist = "blue",
#         fg.hist = rainbow(12)[9])
```

```{r}
# PAM_log_model <- gamlss(formula = PAM_avg ~ Date*Treatment + random(Species_ID), family = SHASH(), data = log_PAM, control = gamlss.control(n.cyc = 250))
# 
# summary(PAM_log_model)
```

###### SQRT transformation of PAM
```{r}
# sqrt_PAM <- filtered_PAM_data %>% 
#   mutate(sqrt_PAM = sqrt(PAM_avg))
# 
# shapiro.test(sqrt_PAM$PAM_avg) # p-value < 0.05, distribution is not normal
# bartlett.test(PAM_avg ~ Treatment, data = sqrt_PAM) # p-value < 0.05, does not meet equal variance assumptions
# 
# exp_test(sqrt_PAM$PAM_avg)        #p-value < 0.05, cannot use
# gamma_test(sqrt_PAM$PAM_avg)      #p-value < 0.05, cannot use
# lnorm_test(sqrt_PAM$PAM_avg)      #p-value < 0.05, cannot use
# normal_test(sqrt_PAM$PAM_avg)     #p-value < 0.05, cannot use
# weibull_test(sqrt_PAM$PAM_avg)    #p-value < 0.05, cannot use
# 
# #Look for anemone resiliancy Fv/Fm
# 
# PAM_sqrt_visual <- fitDist(PAM_avg, data = sqrt_PAM, type = "realAll", try.gamlss = T)
# PAM_sqrt_visual #gives SHASH
# 
# #Visualizing fistDist
# 
# histDist(y, family = SHASH, density = FALSE, 
#         nbins = 10, xlab = "x", ylab = "y", data = PAM_sqrt_visual, 
#         col.hist = "gray", border.hist = "blue", 
#         fg.hist = rainbow(12)[9])
```

```{r}
# PAM_sqrt_model <- gamlss(formula = PAM_avg ~ Date*Treatment + random(Species_ID), family = SHASH(), data = sqrt_PAM, control = gamlss.control(n.cyc = 250))
#  
# summary(PAM_sqrt_model)
```

**PAM graphs**
```{r}
PAM_over_time <- ggplot(data = filtered_PAM_data, aes(x=Date, y = Mean_PAM, colour = Treatment, group = Treatment)) +
  theme_test() +
  geom_point() +
  geom_linerange(aes(ymin = Mean_PAM - SE_PAM, 
                     ymax = Mean_PAM + SE_PAM)) +
  geom_line() +
  labs(x="Event", 
       y = "Average Photosynthetic Efficiency (Fv/Fm)") +
  scale_fill_manual(values = cols_for_heat) +
  scale_colour_manual(values = cols_for_heat)
PAM_over_time + scale_x_discrete(labels=c("11/6/2021" = "Pre-heat", "11/9/2021" = "Post-heat", "11/13/2021" = "Recovery"))
```

```{r}
# 25C - 30C	   	0.02521406	
# 25C - Control	0.50135891	
# 30C - Control	0.06484827	

ggplot(filtered_PAM_data, aes(x = Treatment, y = PAM_avg)) +
  geom_boxplot() +
  theme_test()
```

### Size Data
```{r}
Size_Data <- health_data %>% 
  select(-c(Base_Width, Base_Length, Base_Diagonal, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Weight_Tentacle_mg, Green_Cells, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Green_Density, Dino_Density, MI_Green, MI_Dino, Div_Green, Div_Dino)) %>%
  filter(Date == "11/5/2021" | Date == "11/9/2021" | Date == "11/13/2021") %>% 
  mutate(Date = fct_relevel(Date, "11/5/2021", "11/9/2021", "11/13/2021")) %>% 
  drop_na(Base_Diameter_mm) %>% 
  mutate(Acclimation_Period = as.factor(Acclimation_Period))
```

Checking Distribution:
```{r}
shapiro.test(Size_Data$Base_Diameter_mm) # p-value = 0.0002, distribution is not normal
bartlett.test(Base_Diameter_mm ~ Treatment, data = Size_Data) # p-value = 0.15, yay equal variance

exp_test(Size_Data$Base_Diameter_mm)            #p-value < 0.05
gamma_test(Size_Data$Base_Diameter_mm)          #p-value > 0.05, p = 0.1874
lnorm_test(Size_Data$Base_Diameter_mm)          #p-value > 0.05, p = 0.4117
normal_test(Size_Data$Base_Diameter_mm)         #p-value < 0.05, not normal
weibull_test(Size_Data$Base_Diameter_mm)        #p-value < 0.05

# Run lnorm since it has the higest p value
Size_lnorm <- histDist(Size_Data$Base_Diameter_mm, "LOGNO", density = T, main = "lNorm")

#which has the best distribution? - compare AIC values
Size_lnorm <- histDist(Size_Data$Base_Diameter_mm, "LOGNO", density = T, main = "lNorm")
#AIC = 880.625
Feeding_Gamma <- histDist(Size_Data$Base_Diameter_mm, "GA", density = F, main = "Gamma")
#AIC = 883.161
```

Running Models:
We are going to run a lNorm model on our size data because the p value is larger and AIC value is smaller. 

```{r}
Size_Data$orderTreatment = ordered(Size_Data$Treatment, levels = c("Control", "25C", "30C"))

Size_lNorm_model <- gamlss(formula = Base_Diameter_mm ~ Date*Treatment + random(Species_ID) + random(Field_Site) + random(Acclimation_Period), family = LOGNO(), data = Size_Data, control = gamlss.control(n.cyc = 4))
summary(Size_lNorm_model)
```
We have significance in our 30C treatment. 

**Size Graph**
```{r, warning=FALSE, message=FALSE}
ggplot(Size_Data, aes(x = Date, y = Base_Diameter_mm)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

### Feeding Data
```{r, warning=FALSE, message=FALSE}
Feeding_Data <- health_data %>% 
  select(-c(Base_Width, Base_Length, Base_Diagonal, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Weight_Tentacle_mg, Green_Cells, Dino_Cells, Base_Diameter_mm, Photo_ID, Removed, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Green_Density, Dino_Density, MI_Green, MI_Dino, Div_Green, Div_Dino)) %>%
  filter(Date == "11/5/2021" | Date == "11/9/2021") %>% 
  mutate(Date = fct_relevel(Date, "11/5/2021", "11/9/2021")) %>% 
  drop_na(Feeding_Time_Min) %>% 
  mutate(Acclimation_Period = as.factor(Acclimation_Period))
```

Running test of normality and equal variance on feeding data. 
```{r, warning=FALSE, message=FALSE}
shapiro.test(Feeding_Data$Feeding_Time_Min)                      # p-value < 0.05, distribution is not normal
bartlett.test(Feeding_Time_Min ~ Treatment, data = Feeding_Data) # p-value < 0.05, no equal variance 
```

The data is not equal or normal, so we're are going to check distributions to see what fits best. 
```{r, warning=FALSE, message=FALSE}
exp_test(Feeding_Data$Feeding_Time_Min)            #p-value < 0.05
gamma_test(Feeding_Data$Feeding_Time_Min)          #p-value > 0.05, p = 0.3717, usable
lnorm_test(Feeding_Data$Feeding_Time_Min)          #p-value > 0.05, p = 0.6937, usable
normal_test(Feeding_Data$Feeding_Time_Min)         #p-value < 0.05, not normal
weibull_test(Feeding_Data$Feeding_Time_Min)        #p-value > 0.05, p = 0.088, usable

#which has the best distribution? - compare AIC values
Feeding_lnorm <- histDist(Feeding_Data$Feeding_Time_Min, "LOGNO", density = T, main = "lNorm") 
#AIC = 112.738
Feeding_Gamma <- histDist(Feeding_Data$Feeding_Time_Min, "GA", density = F, main = "Gamma")
#AIC = 116.789
Green_Weibull <- histDist(Feeding_Data$Feeding_Time_Min, "WEI", density = F, main = "Weibull")
#AIC = 115.143
```

Running model:
We are going to use the lnorm distribution because the p value is larger and AIC value is smaller.
```{r, warning=FALSE, message=FALSE}
Feeding_Data$orderTreatment = ordered(Feeding_Data$Treatment, levels = c("Control", "25C", "30C"))

Feeding_lNorm_model <- gamlss(formula = Feeding_Time_Min ~ Date*Treatment + random(Species_ID) + random(Field_Site) + random(Acclimation_Period), family = LOGNO(), data = Feeding_Data, control = gamlss.control(n.cyc = 3))
summary(Feeding_lNorm_model)

```

```{r}
# sara's scribbles

test <- Feeding_Data %>%
  filter(Species_ID != "G15S")

TukeyHSD(aov(Feeding_Time_Min ~ Date*Treatment, data = test))
dunnTest(Feeding_Time_Min ~ Treatment, data = test)
check_model(lm(Feeding_Time_Min ~ Date*Treatment, data = test))

```

Plot:
```{r, warning=FALSE, message=FALSE}
feeding_plot <- ggplot(Feeding_Data, aes(x = Date, y = Feeding_Time_Min, fill = Treatment)) +
  geom_boxplot(alpha=0.85) +
  xlab("Event") +
  ylab("Feeding Time (minutes)") +
  scale_color_manual(values = cols_for_heat) +
  scale_fill_manual(values = cols_for_heat) +
  theme_test()
feeding_plot <- feeding_plot + scale_x_discrete(labels=c("11/5/2021" = "Pre-heat", "11/9/2021" = "Post-heat"))
feeding_plot
ggsave(here("./images/feeding_plot.png"), feeding_plot)
```

## Heat Data
Includes temperature during heatwave and behavioral responses (open vs closed)

```{r, warning=FALSE, message=FALSE}
heat_data <- heat_data %>% 
  mutate(Open_Closed = as.factor(Open_Closed), Bucket = as.factor(Bucket), 
         Treatment = as.factor(Treatment), Field_Site = as.factor(Field_Site)) %>% 
  mutate(Open_Closed = fct_relevel(Open_Closed, "Open", "Partial", "Closed")) %>% 
  mutate(Treatment = fct_relevel(Treatment, "Control", "25C", "30C")) %>% 
  group_by(Treatment, Time_Block) %>% 
  mutate(Temp_avg = mean(Bucket_Temp))
```

**Temperature over time Graph**
```{r, warning=FALSE, message=FALSE}
heat_plot <- ggplot(data = heat_data, aes(x = Time_Block, y = Temp_avg, color = Treatment)) +
  geom_point(size = 1) +
  geom_line(alpha = 1.5) +
  xlab("Time (hours)") +
  ylab("Temperature (°C)") +
  scale_color_manual(values = cols_for_heat) +
  scale_fill_manual(values = cols_for_heat) +
  theme_test()
heat_plot
ggsave(here("./images/heat_plot.png"), heat_plot)
```

### Ordinal Regression
```{r}
ord_model = clmm(Open_Closed ~ Treatment + (1 | Bucket) + (1 | Species_ID), data = heat_data)
summary(ord_model)
```

**Open/Closed Graph**
```{r, warning=FALSE, message=FALSE}
cols_for_behaviour = c("Open" = "bisque1", "Partial" = "brown2", "Closed" = "darkred")
behaviour_data <- heat_data %>% 
  group_by(Day, Treatment, Time_Block) %>% 
  count(Open_Closed)

behaviour_plot <- ggplot(data = behaviour_data, aes(x = Time_Block, y = n, fill = Open_Closed)) + 
  geom_bar(position="fill", stat="identity") +
  facet_grid(. ~ Treatment) +
  xlab("Time (hours)") +
  ylab("Frequency") +
  scale_fill_brewer(palette = "Reds") +
  theme_cowplot()
behaviour_plot <- behaviour_plot + labs(fill = "Behaviour Response")
behaviour_plot

ggsave(here("./images/behaviour_plot.png"), behaviour_plot, width = 10, height = 6)
```

```{r}
otter_simulations = (stage_timeseries2 | stage_timeseries3)
otter_simulations + plot_annotation(tag_levels = 'A')
```

