---
title: "Initial Data Analysis"
author: "Joan Moreaux and Meredith Miller"
date: "07/11/2021"
output:
  pdf_document: default
  html_document: default
---

```{r, warning=FALSE, message=FALSE}
library(performance)
library(DHARMa)
library(mgcv)
library(fitdistrplus)
library(goft)
library(gamlss)
library(FSA) 
library(fGarch)
library(LambertW)
library(ordinal)
library(cowplot)
library(tidyverse)
```

```{r, warning=FALSE, message=FALSE}
health_data <- read.csv("Big_Data_Green.csv")
heat_data <- read.csv("Heat_Data.csv")
```

## Health Data
Includes feeding time, PAM measurements, base measurements, and symbiont density 

```{r, warning=FALSE, message=FALSE}
health_data <- health_data %>% 
  mutate(Fv_Fm_1 = as.numeric(Fv_Fm_1), PAM_avg = ((Fv_Fm_1 + Fv_Fm_2 + Fv_Fm_3)/3)) %>% 
  mutate(Base_Diameter_mm = (Base_Width + Base_Length + Base_Diagonal)/3) %>%
  mutate(Weight_Tentacle_mg = Weight_Tentacle_g*1000) %>% 
  mutate(Green_Density = (Green_Cells/1)*(1/0.1)*(1/0.001)*(0.5/Weight_Tentacle_mg)) %>% 
  mutate(Dino_Density = (Dino_Cells/1)*(1/0.1)*(1/0.001)*(0.5/Weight_Tentacle_mg)) %>%
  mutate(Bucket = as.factor(Bucket), Treatment = as.factor(Treatment), Event = as.factor(Event), 
         Species_ID = as.factor(Species_ID), Field_Site = as.factor(Field_Site)) %>% 
  filter(Species_ID != "G32B" & Species_ID != "G33B")
```

### PAM data
```{r, warning=FALSE, message=FALSE}
shapiro.test(health_data$PAM_avg) # p-value < 0.05, distribution is not normal
bartlett.test(PAM_avg ~ Treatment, data = health_data) # p-value < 0.05, does not meet equal variance assumptions
```

Checking distribution:
If we get get a p-value < 0.5, then they are significantly different and we should not test
Since we cannot use any that we learned in class, we are using fitDist to check many distributions at once. fitDist showed that the SHASH distribution fits the best with our data, so we can use histDist to visualize it. 

```{r, warning=FALSE, message=FALSE}
exp_test(health_data$PAM_avg)        #p-value < 2.2e-16, cannot use
gamma_test(health_data$PAM_avg)      #p-value < 2.2e-16, cannot use
lnorm_test(health_data$PAM_avg)      #p-value < 2.2e-16, cannot use
normal_test(health_data$PAM_avg)     #p-value = 5.414e-08, cannot use
weibull_test(health_data$PAM_avg)    #p-value < 2.2e-16, cannot use
```

**SHASH Distribution Graph for PAM Data**
```{r, warning=FALSE, message=FALSE}

#Look for coral resiliancy Fv/Fm

PAM_visual <- fitDist(PAM_avg, data = health_data, type = "realAll", try.gamlss = T)

# Family:  c("SHASH", "Sinh-Arcsinh"), Fitting method: "nlminb" with 12% error
# Call:  gamlssML(formula = y, family = DIST[i]) 

#Visualizing fistDist

histDist(y, family = SHASH, density = FALSE, 
        nbins = 10, xlab = "x", ylab = "y", data = PAM_visual, 
        col.hist = "gray", border.hist = "blue", 
        fg.hist = rainbow(12)[9])
```

```{r, warning=FALSE, message=FALSE}
#Modelling fitDist

PAM_data <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Green_Density, Dino_Density, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Green, MI_Dino, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3)) %>% 
  drop_na(PAM_avg) %>% 
  drop_na(Event_True) %>% 
  drop_na(Time_Point) %>% 
  filter(Species_ID != "G32B" & Species_ID != "G33B")

PAM_data$orderTreatment = ordered(PAM_data$Treatment, levels = c("Control", "25C", "30C"))

PAM_model <- gamlss(formula = PAM_avg ~ Time_Point*Treatment + random(Species_ID), family = SHASH(), data = PAM_data, control = gamlss.control(n.cyc = 200))

summary(PAM_model)
#                         Estimate Std. Error t value Pr(>|t|)    
#(Intercept)              0.467240   0.007285  64.136   <2e-16 ***
#Time_Point               0.002956   0.001270   2.328   0.0206 *  
#Treatment25C            -0.158368   0.009339 -16.958   <2e-16 ***
#Treatment30C            -0.017513   0.009355  -1.872   0.0623 .  
#Time_Point:Treatment25C -0.001190   0.001675  -0.711   0.4780    
#Time_Point:Treatment30C -0.002611   0.001736  -1.504   0.1337  

#Time point and 25C is signifigant, 30C is not
#plot avg fv/fm over all time points (this was signifigantly different over time)
```

**PAM Graph**
We see no significant differences between treatments at different times of the experiment. 
```{r, warning=FALSE, message=FALSE}
PAM_data_plot <- health_data %>% 
  filter(Event_True == "Acclimation_End" | Event_True == "Heat_End" | Event_True == "Recovery_End")

ggplot(PAM_data_plot, aes(x = Treatment, y = PAM_avg)) +
  geom_boxplot() +
  facet_grid(. ~ Event_True) +
  theme_test()

ggplot(PAM_data, aes(x = Time_Point, y = PAM_avg)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

```{r, warning=FALSE, message=FALSE}
PAM_data_end <- health_data %>% 
  filter(Event_True == "Heat_End") %>% 
  drop_na(PAM_avg)
```

```{r, warning=FALSE, message=FALSE}
ggplot(PAM_data_end, aes(x = Treatment, y = PAM_avg)) +
  geom_boxplot() +
  theme_test()
```

### Symbiont Data
```{r, warning=FALSE, message=FALSE}
filtered_dates <- health_data %>%
  filter(Date == "11/5/2021" | Date == "11/9/2021" | Date == "11/13/2021")

shapiro.test(filtered_dates$Green_Density)      #p-value < 0.05, not normal distribution
bartlett.test(Green_Density ~ Treatment, filtered_dates)      #p-value < 0.05, does not meet assumption of equal variance

shapiro.test(filtered_dates$Dino_Density)      #p-value < 0.05, not normal distribution
bartlett.test(Dino_Density ~ Treatment, filtered_dates)      #p-value < 0.05, does not meet assumption of equal variance
```

Checking distribution:
```{r}
#I dont think that SHASH is the right one i need time to figure this out 
Green_Density_data <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Green, MI_Dino, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True)) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(Time_Point) %>% 
  filter(Green_Density != 0)

#Greens
exp_test(Green_Density_data$Green_Density)         #p-value < 0.05
gamma_test(Green_Density_data$Green_Density)       #p-value > 0.05, larger i can use, p = 0.3315
lnorm_test(Green_Density_data$Green_Density)       #p-value < 0.05
normal_test(Green_Density_data$Green_Density)      #p-value < 0.05, not a normal distribution
weibull_test(Green_Density_data$Green_Density)     #p-value > 0.05, larger i can use, p = 0.936

#Use Weibull since p value is larger than gamma
Green_Weibull <- histDist(Green_Density_data$Green_Density, "WEI", density = F, main = "Weibull")

#Dinos

Dino_Density_data <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Green, MI_Dino, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True)) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(Time_Point) %>% 
  filter(Dino_Density != 0)

exp_test(Dino_Density_data$Dino_Density)           #p-value > 0.05
gamma_test(Dino_Density_data$Dino_Density)         #p-value > 0.05, larger i can use, p = 0.9665
lnorm_test(Dino_Density_data$Dino_Density)         #p-value < 0.05
normal_test(Dino_Density_data$Dino_Density)        #p-value < 0.05, not a normal distribution
weibull_test(Dino_Density_data$Dino_Density)       #p-value > 0.05, larger i can use, p = 0.588

#Use Gamma since p value is larger than weibull
Dino_Gamma <- histDist(Dino_Density_data$Dino_Density, "GA", density = F, main = "Gamma")
```

```{r, warning=FALSE, message=FALSE}
ggplot(filtered_dates, aes(x = Date, y = Green_Density)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

```{r, warning=FALSE, message=FALSE}
ggplot(filtered_dates, aes(x = Date, y = Dino_Density)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

### Size Data
```{r, warning=FALSE, message=FALSE}
shapiro.test(filtered_dates$Base_Diameter_mm) # p-value = 0.001, distribution is not normal
bartlett.test(Base_Diameter_mm ~ Treatment, data = filtered_dates) # p-value = 0.30, yay equal variance
```

Checking Distribution:
```{r}
exp_test(filtered_dates$Base_Diameter_mm)           #p-value < 0.05
gamma_test(filtered_dates$Base_Diameter_mm)         #p-value > 0.05, p = 0.1874
lnorm_test(filtered_dates$Base_Diameter_mm)         #p-value > 0.05, p = 0.4117
normal_test(filtered_dates$Base_Diameter_mm)        #p-value < 0.05, not normal
weibull_test(filtered_dates$Base_Diameter_mm)       #p-value < 0.05

#Run lnorm since it has the higest p value
Size_lnorm <- histDist(filtered_dates$Base_Diameter_mm, "LOGNO", density = T, main = "lNorm")
```

**Size Graph**
```{r, warning=FALSE, message=FALSE}
ggplot(filtered_dates, aes(x = Date, y = Base_Diameter_mm)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

### Feeding Data
```{r, warning=FALSE, message=FALSE}
shapiro.test(filtered_dates$Feeding_Time_Min)      #p-value < 0.05, not normal distribution
bartlett.test(Feeding_Time_Min ~ Treatment, filtered_dates)      #p-value < 0.01, does not meet assumption of equal variance

ggplot(filtered_dates, aes(x = Date, y = Feeding_Time_Min)) +
  geom_boxplot() +
  facet_grid(. ~ Treatment) +
  theme_test()
```

Checking Distributions:
```{r}
Feeding_data <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Green, MI_Dino, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True, Green_Density, Dino_Density, Time_Point)) %>% 
  drop_na(Feeding_Time_Min) 

exp_test(Feeding_data$Feeding_Time_Min)           #p-value < 0.05
gamma_test(Feeding_data$Feeding_Time_Min)         #p-value > 0.05, p = 0.1895
lnorm_test(Feeding_data$Feeding_Time_Min)         #p-value > 0.05, p = 0.5839
normal_test(Feeding_data$Feeding_Time_Min)        #p-value < 0.05, not normal
weibull_test(Feeding_data$Feeding_Time_Min)       #p-value < 0.05

Feeding_lnorm <- histDist(Feeding_data$Feeding_Time_Min, "LOGNO", density = T, main = "lNorm")
```

## Heat Data
Includes temperature during heatwave and behavioral responses (open vs closed)

```{r, warning=FALSE, message=FALSE}
heat_data <- heat_data %>% 
  mutate(Bucket = as.factor(Bucket), Treatment = as.factor(Treatment), Field_Site = as.factor(Field_Site)) %>% 
  group_by(Treatment, Time_Block) %>% 
  mutate(Temp_avg = mean(Bucket_Temp))
```

**Temperature over time Graph**
```{r, warning=FALSE, message=FALSE}
cols_for_heat = my_cols = c("25C" = "chartreuse4", "30C" = "blue4", "Control" = "azure4")
heat_plot <- ggplot(data = heat_data, aes(x = Time_Block, y = Temp_avg, color = Treatment)) +
  geom_point(size = 1) +
  geom_line(alpha = 1.5) +
  xlab("Time (hours)") +
  ylab("Temperature (°C)") +
  scale_color_manual(values = cols_for_heat) +
  scale_fill_manual(values = cols_for_heat) +
  theme_test()
heat_plot
```

**Open/Closed Graph**
```{r, warning=FALSE, message=FALSE}
open_closed_data <- heat_data %>% 
  group_by(Day, Treatment, Time_Block) %>% 
  count(Open_Closed)

ggplot(data = open_closed_data, aes(x = Time_Block, y = n, fill = Open_Closed)) + 
  geom_bar(position="fill", stat="identity") +
  facet_grid(. ~ Treatment) +
  scale_fill_brewer(palette = "Reds") +
  theme_cowplot()
```

