---
title: "Data_Analysis_V2"
author: "Joan Moreaux and Meredith Miller"
date: "22/11/2021"
output: pdf_document
---

```{r, warning=FALSE, message=FALSE}
library(performance)
library(DHARMa)
library(mgcv)
library(fitdistrplus)
library(goft)
library(gamlss)
library(FSA) 
library(fGarch)
library(LambertW)
library(ordinal)
library(cowplot)
library(tidyverse)
```

```{r, warning=FALSE, message=FALSE}
health_data <- read.csv("Big_Data_Green.csv")
heat_data <- read.csv("Heat_Data.csv")
```

## Health Data
Includes feeding time, PAM measurements, base measurements, and symbiont density 

```{r, warning=FALSE, message=FALSE}
health_data <- health_data %>% 
  mutate(Fv_Fm_1 = as.numeric(Fv_Fm_1), PAM_avg = ((Fv_Fm_1 + Fv_Fm_2 + Fv_Fm_3)/3)) %>% 
  mutate(Base_Diameter_mm = (Base_Width + Base_Length + Base_Diagonal)/3) %>%
  mutate(Weight_Tentacle_mg = Weight_Tentacle_g*1000) %>% 
  mutate(Green_Density = (Green_Cells/1)*(1/0.1)*(1/0.001)*(0.5/Weight_Tentacle_mg)) %>% 
  mutate(Dino_Density = (Dino_Cells/1)*(1/0.1)*(1/0.001)*(0.5/Weight_Tentacle_mg)) %>%
  mutate(MI_Green = (Div_Green/Green_Cells)*100, MI_Dino = (Div_Dino/Dino_Cells)*100) %>% #Bates et al. 2010
  mutate(Bucket = as.factor(Bucket), Treatment = as.factor(Treatment), Date = as.factor(Date), Event = as.factor(Event), 
         Species_ID = as.factor(Species_ID), Field_Site = as.factor(Field_Site), Event_True = as.factor(Event_True)) %>% 
  filter(Species_ID != "G32B" & Species_ID != "G33B") %>% 
  mutate(Treatment = fct_relevel(Treatment, "Control", "25C", "30C"))
cols_for_heat = c("25C" = "brown2", "30C" = "darkred", "Control" = "azure4")
```

### Symbiont Data

**Symbiont threshold**
```{r}
green_threshold <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Div_Dino, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Dino, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True, Dino_Density)) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Time_Point) %>% 
  filter(Green_Density != 0)

dino_threshold <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Div_Green, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, MI_Green, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True, Green_Density)) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(Time_Point) %>% 
  filter(Dino_Density != 0)
```

From the data above, we decide that the threshold for PAM will be 1000 cells per mg (symbiont density).

### PAM data
```{r}
PAM_individuals <- health_data %>% 
  filter(Green_Density > 1000 | Dino_Density > 1000) %>% 
  distinct(Species_ID)

PAM_data <- health_data %>% 
  select(-c(Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, 
             Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, 
             Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, Div_Green, Div_Dino, MI_Green,
             MI_Dino)) %>%  
  drop_na(PAM_avg) %>%
  group_by(Treatment, Date) %>% 
  mutate(PAM_per_Treatment = mean(PAM_avg))

# match(PAM_individuals, PAM_data$Species_ID)
```
  
```{r, warning=FALSE, message=FALSE}
shapiro.test(PAM_data$PAM_avg) # p-value < 0.05, distribution is not normal
bartlett.test(PAM_avg ~ Treatment, data = PAM_data) # p-value < 0.05, does not meet equal variance assumptions
```

Our data does not meet the assumption and therefore we will not be able to use tests such as ANOVA and linear models. 

Checking distribution:
If we get get a p-value < 0.5, then they is a significant differnce between the data and the distribution, and therefore this model should not be used in our analyse.

```{r, warning=FALSE, message=FALSE}
exp_test(PAM_data$PAM_avg)        #p-value < 2.2e-16, cannot use
gamma_test(PAM_data$PAM_avg)      #p-value < 0.00334, cannot use
lnorm_test(PAM_data$PAM_avg)      #p-value = 1.97e-07, cannot use
normal_test(PAM_data$PAM_avg)     #p-value = 0.002704, cannot use
weibull_test(PAM_data$PAM_avg)    #p-value < 0.05, cannot use
```

Since we cannot use any that we learned in class, we are using fitDist to check many distributions at once. fitDist showed that the SHASH distribution fits the best with our data, so we can use histDist to visualize it. 

**SHASH Distribution Graph for PAM Data**
```{r, warning=FALSE, message=FALSE}
#Look for anemone resiliancy Fv/Fm

PAM_visual <- fitDist(PAM_avg, data = PAM_data, type = "realAll", try.gamlss = T)
PAM_visual

#Visualizing fistDist

histDist(y, family = SHASH, density = FALSE, 
        nbins = 10, xlab = "x", ylab = "y", data = PAM_visual, 
        col.hist = "gray", border.hist = "blue", 
        fg.hist = rainbow(12)[9])
```

Initially we ran this data and it told us to use a SHASH distribution. [Family:  c("SHASH", "Sinh-Arcsinh"), Fitting method: "nlminb" with 12% error, Call:  gamlssML(formula = y, family = DIST[i])]. After running the data again with updates to our PAM threshold, it was suggested to use the BCEP distribution [Family:  c("BCPE", "Box-Cox Power Exponential"), Call:  gamlss(formula = y ~ 1, family = DIST[i], trace = FALSE)]. After visualizing both the SHASH and BCEP distributions with our updated data, we decided to stick with SHASH since the distribution seemed to fit better. 

```{r, warning=FALSE, message=FALSE}
# Modelling fitDist
PAM_model <- gamlss(formula = PAM_avg ~ Time_Point*Treatment + random(Species_ID), family = SHASH(), data = PAM_data, control = gamlss.control(n.cyc = 200))
```

```{r}
summary(PAM_model)
```

Findings:
* Time point and 25C is signifigant, 30C is not
* Plot avg fv/fm over all time points (this was signifigantly different over time)

**PAM graphs**
```{r}
PAM_avg_plot <- ggplot(data = PAM_data, aes(x = Time_Point, y = PAM_per_Treatment, color = Treatment)) +
  geom_line() +
  geom_point(size = 1) +
  xlab("Time (Days)") +
  ylab("PAM Measurements") +
  scale_color_manual(values = cols_for_heat)  +
  scale_fill_manual(values = cols_for_heat) +
  theme_test() +
  geom_segment(aes(x = 2.5, y = 0.2, xend = 2.5, yend = 0.75), size = 0.5 ,linetype = 2, colour = "black") +
  geom_segment(aes(x = 8.5, y = 0.2, xend = 8.5, yend =0.75), size= 0.35, linetype = 2, colour = "black")
PAM_avg_plot
```

### Density Data
The two datasets below are used in models for algae density and mitotic index of zoochlorellae and zooxathellae. It filters out unwanted columns and drops NAs for Green_Density, Dino_Density, MI_Green and MI_Dino.

```{r}
Green_Symbionts <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True)) %>% 
  filter(Date == "11/5/2021" | Date == "11/9/2021" | Date == "11/13/2021") %>% 
  mutate(Date = fct_relevel(Date, "11/5/2021", "11/9/2021", "11/13/2021")) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(MI_Green) %>% 
  drop_na(MI_Dino) %>% 
  filter(Green_Density != 0)

Dino_Symbionts <- health_data %>% 
  select(-c(Event, Field_Site, Acclimation_Period, Base_Width, Base_Length, Base_Diagonal, Base_Diameter_mm, Nb_Tentacles, Weight_Total_g, Weight_Tube_g, Weight_Tentacle_g, Green_Cells, Dino_Cells, Feeding_Time_Min, Feeding_Time, Feeding_Start, Feeding_Stop, Photo_ID, Removed, Fv_Fm_1, Fv_Fm_2, Fv_Fm_3, PAM_avg, Event_True)) %>% 
  filter(Date == "11/5/2021" | Date == "11/9/2021" | Date == "11/13/2021") %>% 
  mutate(Date = fct_relevel(Date, "11/5/2021", "11/9/2021", "11/13/2021")) %>% 
  drop_na(Green_Density) %>% 
  drop_na(Dino_Density) %>% 
  drop_na(MI_Green) %>% 
  drop_na(MI_Dino) %>% 
  filter(Dino_Density != 0)
```

Checking Normality and Equal Variance:
```{r}
#Green
shapiro.test(Green_Symbionts$Green_Density)      #p-value < 0.05, not normal distribution
bartlett.test(Green_Density ~ Treatment, Green_Symbionts)      #p-value < 0.05, does not meet assumption of equal variance

#Dino
shapiro.test(Dino_Symbionts$Dino_Density)      #p-value < 0.05, not normal distribution
bartlett.test(Dino_Density ~ Treatment, Dino_Symbionts)      #p-value < 0.05, does not meet assumption of equal variance
```

Checking Distributions:
We first test distributions learned in class to see if they fit those with the normal data. We repeat this for both Green and Dino density.
```{r}
#Greens
exp_test(Green_Symbionts$Green_Density)         #p-value < 0.05
gamma_test(Green_Symbionts$Green_Density)       #p-value > 0.05, larger i can use, p = 0.123
lnorm_test(Green_Symbionts$Green_Density)       #p-value < 0.05
normal_test(Green_Symbionts$Green_Density)      #p-value < 0.05, not a normal distribution
weibull_test(Green_Symbionts$Green_Density)     #p-value > 0.05, larger i can use, p = 0.44

#Use Weibull since p value is larger than gamma
Green_Weibull <- histDist(Green_Symbionts$Green_Density, "WEI", density = F, main = "Weibull")

#Dinos
exp_test(Dino_Symbionts$Dino_Density)           #p-value > 0.05
gamma_test(Dino_Symbionts$Dino_Density)         #p-value > 0.05, larger i can use, p = 0.6709
lnorm_test(Dino_Symbionts$Dino_Density)         #p-value < 0.05
normal_test(Dino_Symbionts$Dino_Density)        #p-value < 0.05, not a normal distribution
weibull_test(Dino_Symbionts$Dino_Density)       #p-value > 0.05, larger i can use, p = 0.774

#Use Gamma since p value is larger than weibull
Dino_Gamma <- histDist(Dino_Symbionts$Dino_Density, "GA", density = F, main = "Gamma")
```

Running Models:
We chose to use our Weibull distribution for green density and Gamma distribution for dino density. Here we run our models. 
```{r}
#Green
Green_Symbionts$orderTreatment = ordered(Green_Symbionts$Treatment, levels = c("Control", "25C", "30C"))

Green_Weibull_model <- gamlss(formula = Green_Density ~ Time_Point*Treatment + random(Species_ID), family = WEI(), data = Green_Symbionts, control = gamlss.control(n.cyc = 5))
summary(Green_Weibull_model)

#Dino
Dino_Symbionts$orderTreatment = ordered(Dino_Symbionts$Treatment, levels = c("Control", "25C", "30C"))

Dino_Gamma_model <- gamlss(formula = Dino_Density ~ Time_Point*Treatment + random(Species_ID), family = GA(), data = Dino_Symbionts, control = gamlss.control(n.cyc = 3))
summary(Dino_Gamma_model)
```
The green density data was run with a weibull distribution. This model shows significance in intercept, time point, 30C treatment, and Time point:Treatment 30C. 

The dino density data was run with a gamma distribution. This model shows significance in intercept, treatment 25C and treatment 30C. 

Plots:
```{r, warning=FALSE, message=FALSE}
#Green
green_plot <- ggplot(Green_Symbionts, aes(x = Date, y = Green_Density)) +
  geom_boxplot() +
  xlab("Event") +
  ylab("Green algae density") +
  facet_grid(. ~ Treatment) +
  theme_test()
green_plot + scale_x_discrete(labels=c("11/5/2021" = "Pre-heat", "11/9/2021" = "Post-heat",
                              "11/13/2021" = "Recovery"))

#Dino
dino_plot <- ggplot(Dino_Symbionts, aes(x = Date, y = Dino_Density)) +
  geom_boxplot() +
  xlab("Event") +
  ylab("Dinoflagelatte density") +
  facet_grid(. ~ Treatment) +
  theme_test()
dino_plot + scale_x_discrete(labels=c("11/5/2021" = "Pre-heat", "11/9/2021" = "Post-heat",
                              "11/13/2021" = "Recovery"))
```


